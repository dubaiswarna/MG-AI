// Prisma Schema for AI Trading Platform
// MySQL Database Configuration

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Users & Authentication
model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  name          String?
  password      String    // bcrypt hashed
  role          Role      @default(USER)
  capital       Decimal   @default(2000000) @db.Decimal(15, 2)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLogin     DateTime?
  
  portfolio     Portfolio?
  positions     Position[]
  tradeHistory  TradeHistory[]
  alerts        Alert[]
  
  @@index([email])
}

enum Role {
  USER
  ADMIN
  TRADER
}

// Portfolio Management
model Portfolio {
  id               Int      @id @default(autoincrement())
  userId           Int      @unique
  totalCapital     Decimal  @db.Decimal(15, 2)
  availableCapital Decimal  @db.Decimal(15, 2)
  investedCapital  Decimal  @db.Decimal(15, 2)
  currentValue     Decimal  @db.Decimal(15, 2)
  totalPnL         Decimal  @db.Decimal(15, 2)
  totalPnLPct      Decimal  @db.Decimal(5, 2)
  todayPnL         Decimal  @default(0) @db.Decimal(15, 2)
  activePositions  Int      @default(0)
  updatedAt        DateTime @updatedAt
  
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}

// Active Positions
model Position {
  id            Int       @id @default(autoincrement())
  userId        Int
  symbol        String    @db.VarChar(50)
  entryDate     DateTime
  entryPrice    Decimal   @db.Decimal(10, 2)
  shares        Int
  investment    Decimal   @db.Decimal(15, 2)
  targetPrice   Decimal   @db.Decimal(10, 2)
  stopPrice     Decimal   @db.Decimal(10, 2)
  currentPrice  Decimal?  @db.Decimal(10, 2)
  currentValue  Decimal?  @db.Decimal(15, 2)
  pnl           Decimal?  @db.Decimal(15, 2)
  pnlPct        Decimal?  @db.Decimal(5, 2)
  status        PositionStatus @default(ACTIVE)
  exitDate      DateTime?
  exitPrice     Decimal?  @db.Decimal(10, 2)
  exitReason    String?   @db.VarChar(50)
  daysHeld      Int       @default(0)
  aiConfidence  Decimal?  @db.Decimal(5, 2)
  techScore     Decimal?  @db.Decimal(5, 2)
  notes         String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, symbol])
  @@index([status])
}

enum PositionStatus {
  ACTIVE
  TARGET
  STOP
  FORCED
  MANUAL
}

// Signals Generated
model Signal {
  id               Int       @id @default(autoincrement())
  symbol           String    @db.VarChar(50)
  signalDate       DateTime  @default(now())
  signalType       SignalType @default(BUY)
  currentPrice     Decimal   @db.Decimal(10, 2)
  targetPrice      Decimal   @db.Decimal(10, 2)
  stopPrice        Decimal   @db.Decimal(10, 2)
  aiConfidence     Decimal   @db.Decimal(5, 2)
  techScore        Decimal   @db.Decimal(5, 2)
  hybridConfidence Decimal   @db.Decimal(5, 2)
  trend            String    @db.VarChar(20)
  rsi              Decimal   @db.Decimal(5, 2)
  volumeSurge      Boolean
  reason           String?   @db.Text
  isActive         Boolean   @default(true)
  createdAt        DateTime  @default(now())
  
  @@index([symbol, signalDate])
  @@index([hybridConfidence])
}

enum SignalType {
  BUY
  SELL
  HOLD
}

// Trade History (Closed Positions)
model TradeHistory {
  id            Int       @id @default(autoincrement())
  userId        Int
  symbol        String    @db.VarChar(50)
  entryDate     DateTime
  exitDate      DateTime
  entryPrice    Decimal   @db.Decimal(10, 2)
  exitPrice     Decimal   @db.Decimal(10, 2)
  shares        Int
  investment    Decimal   @db.Decimal(15, 2)
  exitValue     Decimal   @db.Decimal(15, 2)
  pnl           Decimal   @db.Decimal(15, 2)
  pnlPct        Decimal   @db.Decimal(5, 2)
  daysHeld      Int
  exitReason    String    @db.VarChar(50)
  fees          Decimal   @default(0) @db.Decimal(10, 2)
  netPnL        Decimal   @db.Decimal(15, 2)
  createdAt     DateTime  @default(now())
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, symbol])
  @@index([exitDate])
}

// Stock Data Cache
model StockData {
  id        Int      @id @default(autoincrement())
  symbol    String   @db.VarChar(50)
  date      DateTime @db.Date
  open      Decimal  @db.Decimal(10, 2)
  high      Decimal  @db.Decimal(10, 2)
  low       Decimal  @db.Decimal(10, 2)
  close     Decimal  @db.Decimal(10, 2)
  volume    BigInt
  vwap      Decimal? @db.Decimal(10, 2)
  createdAt DateTime @default(now())
  
  @@unique([symbol, date])
  @@index([symbol])
}

// Alerts & Notifications
model Alert {
  id         Int         @id @default(autoincrement())
  userId     Int
  alertType  AlertType
  symbol     String?     @db.VarChar(50)
  message    String      @db.Text
  isRead     Boolean     @default(false)
  priority   Priority    @default(MEDIUM)
  createdAt  DateTime    @default(now())
  
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, isRead])
  @@index([createdAt])
}

enum AlertType {
  TARGET_HIT
  STOP_LOSS
  NEW_SIGNAL
  POSITION_UPDATE
  SYSTEM
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// System Settings
model SystemSettings {
  id                 Int      @id @default(autoincrement())
  settingKey         String   @unique @db.VarChar(100)
  settingValue       String   @db.Text
  description        String?  @db.Text
  updatedAt          DateTime @updatedAt
  
  @@index([settingKey])
}

